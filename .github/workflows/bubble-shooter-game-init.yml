name: Start New Game

on:
  create:

jobs:
  init-game:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          ref: ${{ github.ref_name }}

      - name: Set Up Game State
        run: |
          cp ./states/game-state-template.json ./states/game-state-${{ github.ref_name }}.json

      - name: Commit Game State
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git add ./states/game-state-${{ github.ref_name }}.json
          git commit -m "Initialize a new game"
          git push --set-upstream origin ${{ github.ref_name }}

      - name: Create Pull Request
        run: |
          gh pr create --base main \
            --head ${{ github.ref_name }} \
            --title "NEW GAME STARTED!" \
            --body "ðŸŽ® **LET THE GAMES BEGIN!** ðŸŽ®\
              Get ready to play and have fun! ðŸš€\
              Player 2 will start the game. ðŸŽ²\
              "
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Get Initial Game State and Post as Comment
        run: |
          # Read the game state from the file
          initial_game_state=$(cat ./states/game-state-${{ github.ref_name }}.json)

          # Extract relevant game state information
          player_1_name=$(echo $initial_game_state | jq -r '.player_1.name')
          player_1_score=$(echo $initial_game_state | jq -r '.player_1.score')
          player_2_name=$(echo $initial_game_state | jq -r '.player_2.name')
          player_2_score=$(echo $initial_game_state | jq -r '.player_2.score')
          current_player=$(echo $initial_game_state | jq -r '.current_player')

          # Convert game_state array to markdown format
          game_state_markdown=""

          for row in $(echo $initial_game_state | jq -r '.game_state | .[] | @base64'); do
            row_markdown=$(echo $row | base64 --decode | tr -d '[],"' | tr '\n' ' ' | sed 's/  / | /g')
            game_state_markdown="$game_state_markdown| $row_markdown |\n"
          done

          # Prepare the formatted message
          message="### Initial Game State\n\n**Player 1**: $player_1_name (Score: $player_1_score)\n**Player 2**: $player_2_name (Score: $player_2_score)\n**Current Player**: $current_player\n\n**Game State:**\n\n\`\`\`markdown\n$game_state_markdown\`\`\`"

          # Post the comment with the formatted game state
          pr_number=$(gh pr view --json number -q ".number")
          gh pr comment $pr_number --body "$message"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}